name: Build and Release All Platforms

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build All Platforms and Create Release
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Get version from app.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./app.json').expo.version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Setup Java (for Android builds)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Xcode (for iOS builds)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      # Build all platforms with single script call
      - name: Build all platforms
        id: build_all
        continue-on-error: true
        run: node scripts/build.js apk aab ipa web

      - name: Check build results
        id: check_builds
        run: |
          echo "Checking what was built successfully..."

          # Initialize status variables
          echo "apk_arm64=false" >> $GITHUB_OUTPUT
          echo "apk_v7a=false" >> $GITHUB_OUTPUT
          echo "apk_x86=false" >> $GITHUB_OUTPUT
          echo "aab=false" >> $GITHUB_OUTPUT
          echo "ipa=false" >> $GITHUB_OUTPUT
          echo "web=false" >> $GITHUB_OUTPUT

          # Check each build artifact
          if [ -f "_build/life_events_tracker_${{ steps.get_version.outputs.version }}_arm64-v8a.apk" ]; then
            echo "âœ… APK arm64-v8a found"
            echo "apk_arm64=true" >> $GITHUB_OUTPUT
          fi

          if [ -f "_build/life_events_tracker_${{ steps.get_version.outputs.version }}_armeabi-v7a.apk" ]; then
            echo "âœ… APK armeabi-v7a found"
            echo "apk_v7a=true" >> $GITHUB_OUTPUT
          fi

          if [ -f "_build/life_events_tracker_${{ steps.get_version.outputs.version }}_x86.apk" ]; then
            echo "âœ… APK x86 found"
            echo "apk_x86=true" >> $GITHUB_OUTPUT
          fi

          if [ -f "_build/life_events_tracker_${{ steps.get_version.outputs.version }}_universal.aab" ]; then
            echo "âœ… AAB found"
            echo "aab=true" >> $GITHUB_OUTPUT
          fi

          if [ -f "_build/life_events_tracker_${{ steps.get_version.outputs.version }}_simulator.ipa" ]; then
            echo "âœ… IPA found"
            echo "ipa=true" >> $GITHUB_OUTPUT
          fi

          if [ -f "_build/life_events_tracker_${{ steps.get_version.outputs.version }}_web.zip" ]; then
            echo "âœ… Web found"
            echo "web=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: generate_notes
        run: |
          # Start building release notes
          NOTES="## ðŸš€ Life Events Tracker v${{ steps.get_version.outputs.version }}\n\n"
          NOTES+="### ðŸ“¦ Build Status\n\n"

          # Check what succeeded
          SUCCESS=""
          FAILED=""

          if [ "${{ steps.check_builds.outputs.apk_arm64 }}" == "true" ]; then
            SUCCESS+="âœ… Android APK (arm64-v8a)\n"
          else
            FAILED+="âŒ Android APK (arm64-v8a) - Build failed or timed out\n"
          fi

          if [ "${{ steps.check_builds.outputs.apk_v7a }}" == "true" ]; then
            SUCCESS+="âœ… Android APK (armeabi-v7a)\n"
          else
            FAILED+="âŒ Android APK (armeabi-v7a) - Build failed or timed out\n"
          fi

          if [ "${{ steps.check_builds.outputs.apk_x86 }}" == "true" ]; then
            SUCCESS+="âœ… Android APK (x86)\n"
          else
            FAILED+="âŒ Android APK (x86) - Build failed or timed out\n"
          fi

          if [ "${{ steps.check_builds.outputs.aab }}" == "true" ]; then
            SUCCESS+="âœ… Android AAB (Play Store)\n"
          else
            FAILED+="âŒ Android AAB - Build failed or timed out\n"
          fi

          if [ "${{ steps.check_builds.outputs.ipa }}" == "true" ]; then
            SUCCESS+="âœ… iOS IPA (Simulator)\n"
          else
            FAILED+="âŒ iOS IPA - Build failed, timed out (iOS builds often take 30+ min on CI), or not supported\n"
          fi

          if [ "${{ steps.check_builds.outputs.web }}" == "true" ]; then
            SUCCESS+="âœ… Web Build\n"
          else
            FAILED+="âŒ Web Build - Build failed or timed out\n"
          fi

          # Combine
          if [ -n "$SUCCESS" ]; then
            NOTES+="#### âœ… Successfully Built:\n$SUCCESS\n"
          fi

          if [ -n "$FAILED" ]; then
            NOTES+="#### âŒ Failed Builds:\n$FAILED\n"
          fi

          NOTES+="\n### ðŸ“ Installation Instructions\n\n"
          NOTES+="**Android APK:** Download APK â†’ Enable Unknown Sources â†’ Install\n\n"
          NOTES+="**iOS IPA:** Download IPA â†’ Use AltStore/Sideloadly â†’ Trust certificate\n\n"
          NOTES+="**Web:** Download ZIP â†’ Extract â†’ Deploy to hosting\n\n"
          NOTES+="---\n\n"
          NOTES+="ðŸ¤– Built with [GitHub Actions](https://github.com/features/actions)"

          # Save to file for use in release
          echo -e "$NOTES" > release_notes.md
          cat release_notes.md

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: Release v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false

      # Upload only successful builds
      - name: Upload APK (arm64-v8a)
        if: steps.check_builds.outputs.apk_arm64 == 'true'
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./_build/life_events_tracker_${{ steps.get_version.outputs.version }}_arm64-v8a.apk
          asset_name: life_events_tracker_v${{ steps.get_version.outputs.version }}_arm64-v8a.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload APK (armeabi-v7a)
        if: steps.check_builds.outputs.apk_v7a == 'true'
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./_build/life_events_tracker_${{ steps.get_version.outputs.version }}_armeabi-v7a.apk
          asset_name: life_events_tracker_v${{ steps.get_version.outputs.version }}_armeabi-v7a.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload APK (x86)
        if: steps.check_builds.outputs.apk_x86 == 'true'
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./_build/life_events_tracker_${{ steps.get_version.outputs.version }}_x86.apk
          asset_name: life_events_tracker_v${{ steps.get_version.outputs.version }}_x86.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload AAB
        if: steps.check_builds.outputs.aab == 'true'
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./_build/life_events_tracker_${{ steps.get_version.outputs.version }}_universal.aab
          asset_name: life_events_tracker_v${{ steps.get_version.outputs.version }}_universal.aab
          asset_content_type: application/octet-stream

      - name: Upload IPA (Simulator)
        if: steps.check_builds.outputs.ipa == 'true'
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./_build/life_events_tracker_${{ steps.get_version.outputs.version }}_simulator.ipa
          asset_name: life_events_tracker_v${{ steps.get_version.outputs.version }}_simulator.ipa
          asset_content_type: application/octet-stream

      - name: Upload Web Build
        if: steps.check_builds.outputs.web == 'true'
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./_build/life_events_tracker_${{ steps.get_version.outputs.version }}_web.zip
          asset_name: life_events_tracker_v${{ steps.get_version.outputs.version }}_web.zip
          asset_content_type: application/zip

      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Build and Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release v${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Success section
          echo "### âœ… Successfully Built:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_builds.outputs.apk_arm64 }}" == "true" ]; then
            echo "- Android APK (arm64-v8a)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.apk_v7a }}" == "true" ]; then
            echo "- Android APK (armeabi-v7a)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.apk_x86 }}" == "true" ]; then
            echo "- Android APK (x86)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.aab }}" == "true" ]; then
            echo "- Android AAB" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.ipa }}" == "true" ]; then
            echo "- iOS IPA (Simulator)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.web }}" == "true" ]; then
            echo "- Web Build" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Failed section
          echo "### âŒ Failed Builds:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_builds.outputs.apk_arm64 }}" != "true" ]; then
            echo "- Android APK (arm64-v8a)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.apk_v7a }}" != "true" ]; then
            echo "- Android APK (armeabi-v7a)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.apk_x86 }}" != "true" ]; then
            echo "- Android APK (x86)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.aab }}" != "true" ]; then
            echo "- Android AAB" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.ipa }}" != "true" ]; then
            echo "- iOS IPA (likely timed out - iOS builds take 30+ min on CI)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check_builds.outputs.web }}" != "true" ]; then
            echo "- Web Build" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
